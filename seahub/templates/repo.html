{% extends "myhome_base.html" %}

{% load seahub_tags avatar_tags i18n upload_tags %}

{% block sub_title %}{{repo.name}} - {% endblock %}
{% block extra_style %}
<style type="text/css">
#main { width:auto; }
#footer { display:none; }
</style>    
<!-- Shim to make HTML5 elements usable in older Internet Explorer versions -->
<!--[if lt IE 9]><script src="{{ MEDIA_URL}}js/html5shiv.js"></script><![endif]-->
{% endblock %}

{% block main_panel %}
    <div id="repo-top">
        <div class="block-inner">
            <div class="w100 ovhd">
                <h2 class="fleft">{{repo.props.name}}{% if user_perm == 'r' %} <span class="tip vam">({% trans "Read-Only" %})</span>{% endif %}</h2>
                <div class="fright">
                    <button id="repo-download-btn" class="repo-top-op-btn"><span class="icon-cloud-download"></span>{% trans "Download"%}</button>
                    {% if is_repo_owner %}
                    <button id="repo-setting-btn" class="repo-top-op-btn"><span class="icon-cog"></span>{% trans "Settings" %}</button>
                    {% endif %}
                    {% if user_perm == 'rw' %}
                    <button id="recycle-btn" data="{% url 'repo_recycle_view' repo.id %}" class="repo-top-op-btn"><span class="icon-trash"></span>{% trans "Trash"%}</button>
                    {% endif %}
                </div>
            </div>

            <p id="repo-basic-info">
            <span class="desc">{{repo.props.desc}}</span>
            <span class="size split">{% trans 'Size: ' %}{{ repo_size|filesizeformat }}</span>
            </p>

            <div id="repo-latest-commit">
                {% include 'snippets/current_commit.html' %}
            </div>
        </div>
    </div>

    <div id="repo-file-list">
        {% include 'snippets/repo_dir_data.html' %}
    </div>

    <!-- popups -->
    {% if user_perm == 'rw' %}
    <div id="dirents-op" class="hide">
        <button id="del-dirents" title="{% trans "Delete"%}" class="op-icon-btn"><span class="icon-trash"></span></button>
        <button id="mv-dirents" title="{% trans "Move"%}" class="op-icon-btn"><span class="icon-move"></span></button>
        <button id="cp-dirents" title="{% trans "Copy"%}" class="op-icon-btn"><span class="icon-copy"></span></button>
    </div>
    {% endif %}
    <div id="upload-file-dialog" class="hide">
        <h3>{% trans "Upload Files" %}</h3>
        {% if no_quota %}
        <p class="error">{% trans "The owner of this library has ran out of space." %}</p>
        {% else %}
        <form id="upload-file-form" enctype="multipart/form-data" method="post" action="{{ajax_upload_url}}">{% csrf_token %}
            <input type="hidden" name="parent_dir" id="parent_dir" value="{{ path }}" />
            <div class="row fileupload-buttonbar">
                <div>
                    <span class="fileinput-button vam">
                        <span class="icon-plus"></span>
                        <span>{% trans "Add Files" %}</span>
                        <input type="file" name="file" multiple />
                    </span>
                    <button type="submit" class="start vam">
                        <span class="icon-upload"></span>
                        <span>{% trans "Start All" %}</span>
                    </button>
                    <button type="reset" class="cancel vam">
                        <span class="icon-ban-circle"></span>
                        <span>{% trans "Cancel All" %}</span>
                    </button>
                </div>
                <ol class="tip">
                    <li>{% trans "Drag & Drop is supported for Chrome, Safari 5.0+, Firefox 4.0+, IE 10.0+" %}</li>
                    <li>{% blocktrans with max_file_size=max_upload_file_size|filesizeformat %}Total size should be smaller than {{ max_file_size }}{% endblocktrans %}</li>
                </ol>
                <div class="fileupload-progress fade">
                    <div class="progress progress-success progres-striped active">
                        <div class="bar" style="width:0%"></div>
                    </div>
                    <div class="progress-extended"></div>
                </div>
            </div>
            <table class="table table-striped"><tbody class="files" data-toggle="modal-gallery" data-target="#modal-gallery"></tbody></table>
        </form>
        {% endif %}
    </div>

    <div id="update-file-dialog" class="hide">
        <h3 class="hd">{% trans "Update %(file_name)s" %}</h3>
        {% if no_quota %}
        <p class="error">{% trans "The owner of this library has ran out of space." %}</p>
        {% else %}      
        <form id="update-file-form" enctype="multipart/form-data" method="post" action="">{% csrf_token %}
            <input type="hidden" name="target_file" />
            <div class="fileupload-buttonbar">
                <span class="fileinput-button vam">
                    <span>{% trans "Choose a file" %}</span>
                    <input type="file" name="file" />
                </span>
                <span class="vam">({% blocktrans with max_file_size=max_upload_file_size|filesizeformat %}Smaller than {{ max_file_size }}{% endblocktrans %})</span>
                <div class="fileupload-progress fade">
                    <div class="progress progress-success progres-striped active">
                        <div class="bar" style="width:0%"></div>
                    </div>
                    <div class="progress-extended"></div>
                </div>
            </div>
            <table class="table table-striped"><tbody class="files" data-toggle="modal-gallery" data-target="#modal-gallery"></tbody></table>
        </form>
        {% endif %}
    </div>

    {% if is_repo_owner %}
    <form id="repo-setting-form" action="" method="post" class="simple-input-popup hide">{% csrf_token %}
        <h3>{% trans "Library Settings" %}</h3>
        <label>{% trans "Name" %}</label><br />
        <input type="text" name="repo_name" value="{{ repo.name }}" class="long-input" /><br />
        <label>{% trans "Description" %}</label></br />
        <input type="text" name="repo_desc" value="{{ repo.desc }}" class="long-input" /><br />
        <input type="hidden" name="repo_id" value="{{ repo.id }}" />
	{% if not ENABLE_SUB_LIBRARY or not repo.is_virtual %}
        <label>{% trans "History" %}</label><br />
        <input type="radio" name="history" value="full_history" {% if history_limit < 0 %}checked="checked"{% endif %} class="vam" /> <span class="vam">{% trans "Keep full history" %}</span><br />
        <input type="radio" name="history" value="no_history" {% if history_limit == 0 %}checked="checked"{% endif %} class="vam" /> <span class="vam">{% trans "Don't keep history" %}</span><br />
        <input type="radio" name="history" value="partial_history" {% if history_limit > 0 %}checked="checked"{% endif %} class="vam" /> <span calss="vam">{% trans "Only keep a period of history:" %} <input type="text" name="days" size="4" {% if history_limit <= 0 %} disabled="disabled" class="input-disabled" {% else %} value="{{history_limit}}" {% endif %} /> {% trans "days" %}</span><br />
	{% endif %}
        <p class="error hide"></p>
        <input type="submit" value="{% trans "Submit" %}" class="submit" />
        <button class="simplemodal-close">{% trans "Cancel" %}</button>
    </form>
    {% endif %}

    <form id="add-new-dir-form" action="" method="post" class="simple-input-popup hide">{% csrf_token %}
        <h3>{% trans "New Directory" %}</h3>
        <label>{% trans "Directory Name" %}</label><br /><!-- <br/> for ie 7 -->
        <input type="text" name="name" value="" class="long-input" maxlength="{{max_file_name}}"/><br />
        <p class="error hide"></p>
        <input type="submit" value="{% trans "Submit" %}" class="submit" />
        <button class="simplemodal-close">{% trans "Cancel" %}</button>
    </form>

    <form id="add-new-file-form" action="" method="post" class="simple-input-popup hide">{% csrf_token %}
        <h3>{% trans "New File" %}</h3>
        <div id="featured-filetype">
            <label>{% trans "Featured File Type" %}</label><br />
            <button type="button" class="set-file-type" data-filetype="seaf" title="{% trans "Click to choose" %}">seaf</button> <span>{% trans "online Rich Text format." %}</span>
            {% if LANGUAGE_CODE == 'zh-cn' %}
            <a href="http://www.seafile.com/help/seaf/" target="_blank">{% trans 'Details' %}</a><br /> 
            {% else %}
            <a href="http://www.seafile.com/en/help/seaf/" target="_blank">{% trans 'Details' %}</a><br /> 
            {% endif %}
            <button type="button" class="set-file-type" data-filetype="md" title="{% trans "Click to choose" %}">markdown</button> <span>{% trans "simple markup format." %}</span>
            {% if LANGUAGE_CODE == 'zh-cn' %}
            <a href="http://www.seafile.com/help/markdown/" target="_blank">{% trans 'Details' %}</a>            
            {% else %}
            <a href="http://www.seafile.com/en/help/markdown/" target="_blank">{% trans 'Details' %}</a>            
            {% endif %}
        </div>
        <label>{% trans "File Name" %}</label><br/>
        <input type="text" name="name" value="" class="long-input" maxlength="{{max_file_name}}"/><br />
        <p class="error hide"></p>
        <input type="submit" value="{% trans "Submit"%}" class="submit" />
        <button class="simplemodal-close">{% trans "Cancel"%}</button>
    </form>

    <form id="mv-form" action="" method="post" class="file-choose-form hide">{% csrf_token %}
        <div id="mv-dir-list" class="dir-tree-cont">
            <h5><span class="tri-bg tri-down-bg"></span>{% trans "Current Library"%}</h5>
            <div id="current-repo-dirs"></div>
            <h5><span class="tri-bg tri-right-bg"></span>{% trans "Other Libraries"%}</h5>
            <div id="other-repos-dirs" class="hide"></div>
        </div>
        <input type="hidden" name="obj_name" value="" />
        <input type="hidden" name="obj_type" value="" />
        <input type="hidden" name="op" value="" />
        <input type="hidden" name="dst_repo" value="" />
        <input type="hidden" name="dst_path" value="" />
        <p class="error hide">{% trans "Please click and choose a directory."%}</p>
        <input type="submit" value="{% trans "Submit"%}" class="submit" />
        <button class="simplemodal-close">{% trans "Cancel"%}</button>
    </form>

    <form id="rename-form" action="" method="post" class="simple-input-popup hide">{% csrf_token %}
        <p class="detail">{% trans "Rename %(name)s as:" %}</p>
        <input type="hidden" name="oldname" value="" />
        <input type="text" name="newname" value="" class="long-input" maxlength="{{max_file_name}}"/><br />
        <p class="error hide"></p>
        <input type="submit" value="{% trans "Submit"%}" class="submit" />
        <button class="simplemodal-close">{% trans "Cancel"%}</button>
    </form>

    {% include "snippets/file_share_popup.html" %}

    {% with attach_type='dir' %}
    {% include "snippets/group_recommend_form.html" %}
    {% endwith %}

    {% if ENABLE_SUB_LIBRARY and not repo.is_virtual %}
    <div id="dir-sync-popup" class="hide">
        <h3 class="hd">{% trans "Sync %(dir_name)s" %}</h3>
        <p class="sub-repo-create-tip hide">{% trans "You need to create a sub-library from this directory to sync it." %}</p>
        <button class="create-sub-repo hide">{% trans "Create" %}</button>
        <p class="sub-repo-creating-progress hide"></p>
        <p class="sub-repo-exist-tip hide">{% trans "The sub-library used to sync this directory already exists." %}</p>
        <button id="sync-sub-repo" class="hide">{% trans "Sync" %}</button>
        <p class="tip" style="margin-bottom:0">{% trans "A sub-library can be created from any folder. It can be independently synced and shared. Files in the sub-library will be automatically kept in sync with those in the directory of the origin library." %}</p>
    </div>
    {% endif %}

    {% url 'share_repo' as repo_share_url %}
    {% with post_url=repo_share_url groups=joined_groups %}
    {% include "snippets/repo_share_form.html" %} {# for sub-lib share #}
    {% endwith %}    

{% endblock %}

{% block extra_script %}
{% upload_js %}
<script src="{{ MEDIA_URL}}js/jquery.ui.widget.js"></script>
<script src="{{ MEDIA_URL}}js/tmpl.min.js"></script>
<script src="{{ MEDIA_URL }}js/jquery.iframe-transport.js"></script>
<script src="{{ MEDIA_URL }}js/jquery.fileupload.js"></script>
<script src="{{ MEDIA_URL }}js/jquery.fileupload-fp.js"></script>
<script src="{{ MEDIA_URL }}js/jquery.fileupload-ui.js"></script>
<script type="text/javascript">
// for file upload
window.locale = { 
    "fileupload": {
        "errors": {
            "maxFileSize": "{% trans "File is too big" %}",
            "minFileSize": "{% trans "File is too small" %}",
            "acceptFileTypes": "{% trans "Filetype not allowed" %}",
            "maxNumberOfFiles": "{% trans "Max number of files exceeded" %}",
            "uploadedBytes": "{% trans "Uploaded bytes exceed file size" %}",
            "emptyResult": "{% trans "Empty file upload result" %}"
        },  
        "error": "{% trans "Error" %}",
        "start": "{% trans "Start" %}",
        "cancel": "{% trans "Cancel" %}",
        "destroy": "{% trans "Delete" %}"
    }   
};

//download, trash
$('#repo-download-btn').click(function() {
    window.open('{{ SITE_ROOT }}seafile_access_check/?repo_id={{repo.props.id}}');
});

$('#recycle-btn').click(function() {
    location.href = $(this).attr('data');
});

{% if is_repo_owner %}
$('#repo-setting-btn').click(function () {
    $('#repo-setting-form').modal({appendTo:'#main'});
});

{% if not ENABLE_SUB_LIBRARY or not repo.is_virtual %}
$('#repo-setting-form input[name="history"]').change(function() {
    var value = $(this).attr('value'),
        days_input = $('#repo-setting-form input[name="days"]');
    if (value == 'full_history' || value == 'no_history') {
        days_input.attr('disabled', true).addClass('input-disabled');
    } else {
        days_input.attr('disabled', false).removeClass('input-disabled');
    }
});
{% endif %}

$('#repo-setting-form').submit(function() {
    {% if not ENABLE_SUB_LIBRARY or not repo.is_virtual %}
    var days;
    var value = $(this).find('input[name="history"]:checked').val();

    if (value == 'partial_history') {
        days = $(this).find('input[name="days"]').val();
    } else if (value == 'full_history') {
        days = -1;
    } else {
        days = 0;
    }
    {% endif %}

    var submit_btn = $(this).children('input[type="submit"]');  
    disable(submit_btn);
    $.ajax({
        url: '{% url 'views.repo_save_settings' %}',
        type: 'POST',
        dataType: 'json',
        beforeSend: prepareCSRFToken,
        data: {
            'repo_id': $('#repo-setting-form input[name="repo_id"]').val(),
            'repo_name': $('#repo-setting-form input[name="repo_name"]').val(),
            'repo_desc': $('#repo-setting-form input[name="repo_desc"]').val(),
            {% if not ENABLE_SUB_LIBRARY or not repo.is_virtual %}
            'days': days 
            {% endif %}
        },
        success: function(data) {
            if (data['success']) {
                location.reload(true);
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            if (jqXHR.responseText) {
                apply_form_error('repo-setting-form', $.parseJSON(jqXHR.responseText).error);
            } else {
                apply_form_error('repo-setting-form', "{% trans "Failed. Please check the network." %}");
            }
            enable(submit_btn);
        }
    });
    return false;
});
{% endif %}

function setDirentsOpPos() {
    var dirents_op = $('#dirents-op');
    dirents_op.css({
        'left': $('#repo-file-list').offset().left - dirents_op.outerWidth(true) - 20,
        'top': $(window).height()/2
    });
}

$('#del-dirents').click(function() {
    $('#confirm-popup').modal({appendTo:'#main'});
    $('#simplemodal-container').css({'height':'auto'});
    $('#confirm-con').html('<h3>' + "{% trans "Delete Items" %}" + '</h3><p>' + "{% trans "Are you sure you want to delete these selected items?" %}" + '</p>');
    $('#confirm-yes').unbind().click(del_dirents);
});
var del_dirents = function() {
    $('#confirm-popup').append('<p style="color:red;">' + "{% trans "Processing..." %}" + '</p>');
    var dirents = $('.checkbox-checked').parents('.dir-item, .file-item'),
        dirents_names = [];
    dirents.each(function() {
        dirents_names.push($(this).data('name'));
    });
    $.ajax({
        url: '{% url 'delete_dirents' repo.id %}' + '?parent_dir=' + e(cur_path),
        type: 'POST',
        dataType: 'json',
        beforeSend: prepareCSRFToken,
        traditional: true,
        data: {
            'dirents_names': dirents_names
        },
        success: function(data) {
            var deleted_len = data['deleted'].length,
                msg_s, msg_f;
            
            if (deleted_len > 0) {
                if (deleted_len == dirents_names.length) {
                    dirents.remove();
                } else {
                    dirents.each(function() {
                        if ($(this).data('name') in data['deleted']) {
                            $(this).remove();
                        }
                    }); 
                }
                if (data['deleted'].length > 1) {
                    msg_s = "{% trans "Successfully deleted %(name)s and %(amount)s other items." %}";
                } else {
                    msg_s = "{% trans "Successfully deleted %(name)s." %}";
                }
                msg_s = msg_s.replace('%(name)s', data['deleted'][0]).replace('%(amount)s', data['deleted'].length - 1);
                feedback(msg_s, 'success'); 
                updateCmt();
            }

            if (data['undeleted'].length > 0) {
                if (data['undeleted'].length > 1) {
                    msg_f = "{% trans "Internal error. Failed to delete %(name)s and %(amount)s other items." %}"
                } else {
                    msg_f = "{% trans "Internal error. Failed to delete %(name)s." %}"
                }
                msg_f = msg_f.replace('%(name)s', data['undeleted'][0]).replace('%(amount)s', data['undeleted'].length - 1);
                feedback(msg_f, 'error'); 
            }
            $.modal.close();
            $('#dirents-op').addClass('hide');
            $('th.select .checkbox').removeClass('checkbox-checked');
        },
        error: function(xhr, textStatus, errorThrown) {
            $.modal.close();
            ajaxErrorHandler(xhr, textStatus, errorThrown);
        }
    });
};

$('#mv-dirents, #cp-dirents').click(function() {
    var form = $('#mv-form'), op;
    form.modal({appendTo:'#main', autoResize:true, focus:false});
    $('#simplemodal-container').css({'width':'auto', 'height':'auto'});

    if ($(this).attr('id') == 'mv-dirents') {
        op = 'mv';
        form.prepend("<h3>{% trans "Move selected directories/files to:" %}</h3>");
    } else {
        op = 'cp';
        form.prepend("<h3>{% trans "Copy selected directories/files to:" %}</h3>");
    }

    var file_tree = new FileTree();
    file_tree.renderDirTree($('#current-repo-dirs').data('site_root', '{{SITE_ROOT}}'), form, current_repo);

    var files = $('.checkbox-checked').parents('.file-item'),
        dirs = $('.checkbox-checked').parents('.dir-item'),
        dir_names = [], file_names = [];

    files.each(function() {
        file_names.push($(this).data('name'));
    });
    dirs.each(function() {
        dir_names.push($(this).data('name'));
    });

    form.submit(function() {
        var dst_repo = $('[name="dst_repo"]', form).val(),
            dst_path = $('[name="dst_path"]', form).val(),
            url_main;

        if (!$.trim(dst_repo) || !$.trim(dst_path)) {
            $('.error', form).removeClass('hide');
            return false;
        }
        if (dst_repo == '{{repo.id }}' && dst_path == cur_path) {
            $('.error', form).html("{% trans "Invalid destination path" %}").removeClass('hide');
            return false;
        }

        if (op == 'mv') {
            url_main = '{% url 'mv_dirents' repo.id %}';
        } else {
            url_main = '{% url 'cp_dirents' repo.id %}';
        }

        disable($('[type="submit"]', form));
        form.append('<p style="color:red;">' + "{% trans "Processing..." %}" + '</p>');
        $.ajax({
            url: url_main + '?parent_dir=' + e(cur_path),
            type: 'POST',
            dataType: 'json',
            beforeSend: prepareCSRFToken,
            traditional: true,
            data: {
                'file_names': file_names,
                'dir_names': dir_names,
                'dst_repo': dst_repo,
                'dst_path': dst_path
            },
            success: function(data) {
                var success_len = data['success'].length,
                    msg_s, msg_f;

                $.modal.close();
                $('#dirents-op').addClass('hide');
                $('th.select .checkbox').removeClass('checkbox-checked');

                if (success_len > 0) {
                    if (op == 'mv') {
                        if (success_len == files.length + dirs.length) {
                            files.remove();
                            dirs.remove();
                        } else {
                            files.each(function() {
                                if ($(this).data('name') in data['success']) {
                                    $(this).remove();
                                }
                            }); 
                            dirs.each(function() {
                                if ($(this).data('name') in data['success']) {
                                    $(this).remove();
                                }
                            }); 
                        }
                        if (data['success'].length > 1) {
                            msg_s = "{% trans "Successfully moved %(name)s and %(amount)s other items." %}";
                        } else {
                            msg_s = "{% trans "Successfully moved %(name)s." %}";
                        }
                    } else {
                        $('.checkbox').removeClass('checkbox-checked');
                        if (data['success'].length > 1) {
                            msg_s = "{% trans "Successfully copied %(name)s and %(amount)s other items." %}";
                        } else {
                            msg_s = "{% trans "Successfully copied %(name)s." %}";
                        }
                    }
                    msg_s = msg_s.replace('%(name)s', data['success'][0]).replace('%(amount)s', data['success'].length - 1);
                    msg_s += ' <a href="' + data['url'] + '">' + "{% trans "View" %}" + '</a>';
                    feedback(msg_s, 'success'); 
                    updateCmt();
                }

                if (data['failed'].length > 0) {
                    if (op == 'mv') {
                        if (data['failed'].length > 1) {
                            msg_f = "{% trans "Internal error. Failed to move %(name)s and %(amount)s other items." %}";
                        } else {
                            msg_f = "{% trans "Internal error. Failed to move %(name)s." %}";
                        }
                    } else {
                        if (data['failed'].length > 1) {
                            msg_f = "{% trans "Internal error. Failed to copy %(name)s and %(amount)s other items." %}";
                        } else {
                            msg_f = "{% trans "Internal error. Failed to copy %(name)s." %}";
                        }
                    }
                    msg_f = msg_f.replace('%(name)s', data['failed'][0]).replace('%(amount)s', data['failed'].length - 1);
                    feedback(msg_f, 'error'); 
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                $.modal.close();
                ajaxErrorHandler(xhr, textStatus, errorThrown);
            }
        });
        return false;
    });
});

// js on repo file list
var no_file_op_popup = true;

function dirOP() {

$('.path .dir-link').click(dirlinkClick);

$('#upload-file').click(function () {
    var upload_success = false;
    $('#upload-file-dialog').modal({
        focus:false,
        containerCss: {width:600, height:$(window).height()/1.5},
        onClose: function() {
            $.modal.close();
            if (upload_success) {
                reqDirData('{% url 'repo_dir_data' repo.id %}?p=' + e(cur_path));
                updateCmt();
            }
        }
    });
    $('.simplemodal-wrap').css({'overflow':'auto'}); // for ie

    var form = $('#upload-file-form');
    $('input[name="parent_dir"]', form).val(cur_path);

    // Initialize the jQuery File Upload widget:
    form.fileupload({
        //singleFileUploads: false // using 1 request to upload all files of a selection
        sequentialUploads: true
    })
    .bind('fileuploaddone', function(e, data) {
        if (data.textStatus == 'success') {
            upload_success = true; 
        }
    });

    // Enable iframe cross-domain access via redirect option:
    form.fileupload(
        'option',
        'redirect',
        window.location.href.replace(/\/repo\/[-a-z0-9]{36}\/.*/, '/media/cors/result.html?%s')
    );
});

$('#add-new-dir').click(function () {
    $('#add-new-dir-form').modal({appendTo:'#main'});
    $('#simplemodal-container').css({'height':'auto'});
});
  
$('#add-new-file').click(function () {
    $('#add-new-file-form').modal({appendTo:'#main', focus:false, containerCss:{'padding':'20px 25px'}});
    $('#simplemodal-container').css({'height':'auto'});
});

// share current dir
$('#share-cur-dir').click(function() {
   var op = $(this), name, aj_url, type;
   name = $('#cur-dir-name').html();
   aj_url = op.data('url');
   type = 'd';
   showSharePopup(op, name, aj_url, type, cur_path);
});

//select all or not
$('th .checkbox-orig').unbind().click(function() {
    var dirents_op = $('#dirents-op');

    // keep all checkbox in the same state: selected or not
    // a case: select all, and then scroll to req 'more'...
    $(this).parent().toggleClass('checkbox-checked');
    if ($(this).parent().hasClass('checkbox-checked')) {
        $('.checkbox').addClass('checkbox-checked');
    } else {
        $('.checkbox').removeClass('checkbox-checked');
    }

    // show buttons or not
    if ($('.checkbox-checked', $('.dir-item, .file-item')).length > 0) {
        dirents_op.removeClass('hide');
        setDirentsOpPos();
    } else {
        dirents_op.addClass('hide');
    }
});

//sort
$('#name-down, #name-up, #time-up, #time-down').click(sortDirent);

$('.dir-item, .file-item').unbind().hover( // remove previously binded hover handler at first
    function() {
        if (no_file_op_popup) {
            $(this).addClass('hl').find('.repo-file-op').removeClass('vh');
        }
    },
    function() {
        if (no_file_op_popup) {
            $(this).removeClass('hl').find('.repo-file-op').addClass('vh');
        }
    }
);

opOnDirent();

} // function dirOP ends here

dirOP();

function sortDirent() {
    var id= $(this).attr('id'), by,
        dir_list = [], file_list = [],
        table = $('.repo-file-list');
    
    switch (id) {
        case 'name-down': by = function(a, b) { return a.name.toLowerCase() < b.name.toLowerCase() ? 1 : -1 };break;
        case 'name-up': by = function(a, b) { return a.name.toLowerCase() < b.name.toLowerCase() ? -1 : 1 };break;
        case 'time-up': by = function(a, b) { return a.time < b.time ? -1 : 1 };break;
        case 'time-down': by = function(a, b) { return a.time < b.time ? 1 : -1 };break;
    }

    // when 'name' is like '123', `data('name')` return number 123 
    $('.dir-item').each(function() {
        dir_list.push({'name':$(this).attr('data-name'), 'time':$(this).data('time'), 'element':this});
    });
    $('.file-item').each(function() {
        file_list.push({'name':$(this).attr('data-name'), 'time':$(this).data('time'), 'element':this});
    });

    dir_list.sort(by);
    file_list.sort(by);

    $('.dir-item, .file-item').detach();

    $(dir_list).each(function(index, item) {
        table.append(item.element);
    });
    $(file_list).each(function(index, item) {
        table.append(item.element);
    });
  
    $(this).hide();
    switch (id) {
        case 'name-down': $('#name-up').css({'display':'inline-block'}); break;
        case 'name-up': $('#name-down').removeAttr('style'); break;
        case 'time-up': $('#time-down').removeAttr('style'); break;
        case 'time-down': $('#time-up').css({'display':'inline-block'}); break;
    }
}

var loading_icon = '<img src="{{MEDIA_URL}}img/loading-icon.gif" alt="{% trans "Loading..." %}" class="vam" />';
// cur_path: will be updated after reqDirdata
var cur_path = '{{ path }}';

// '.dir-link' click handler
function dirlinkClick() {
    var link = $(this);

    // add loading icon
    if (link.parent().attr('class') == 'dirent-name') {
        // link is in repo-file-list
        link.parents('.dir-item').children('.dirent-icon').html(loading_icon);
    } else {
        // link is in '.path'
        $('#cur-dir-name').after(' ' + loading_icon);
    }
    var url_search = link.attr('href').substr(link.attr('href').indexOf('?'));
    reqDirData('{% url 'repo_dir_data' repo.id %}' + url_search, changeLocation);
    return false;
}
function changeLocation(data) {
    if (window.history.pushState) {
        window.history.pushState({'path': e(data['path'])},'','?p=' + e(data['path'])); // the 3rd argument is a relative url
    }
}
function reqDirData(url, func) {
    var orig_wtop = $(window).scrollTop();
    $.ajax({
        url: url,
        cache: false,
        dataType: 'json',
        success: function(data) {
            $('#repo-file-list').html(data['html']);
            
            // both original dir list and new dir list are long
            var repo_top = $('#repo-top'),
                h = repo_top.offset().top + repo_top.outerHeight(true);
            if (orig_wtop > h && $(window).scrollTop() == orig_wtop) {
                $(window).scrollTop(h);
            }

            cur_path = data['path']; // update cur_path
            if (func) {
                func(data);
            }
            dirOP();
            // in case the 'discuss' & #dirents-op popup is open before this request
            $('#discuss-to-group, #discuss-to-group-caret, #dirents-op').addClass('hide');
        },
        error:function(xhr, textStatus, errorThrown) {
            if (xhr.responseText) {
                feedback(jQuery.parseJSON(xhr.responseText).err_msg, 'error');
            } else {
                feedback("{% trans "Failed. Please check the network." %}", 'error');
            }
        }
    });
}

// choose featured filetype
$('.set-file-type').click(function() {
   var file_name = $('#add-new-file-form input[name="name"]');
   file_name.val('.' + $(this).data('filetype'));
   setCaretPos(file_name[0], 0);
});

var current_repo = [],
    other_repos = [];
{% if repo.encrypted %}
    current_repo.push({
        'data': '{{ repo.props.name }}',
        'attr': {'repo_id': '{{ repo.props.id }}'},
        'state': 'closed'
    });  
{% else %}
    {% for a_repo in accessible_repos %}
    {% if a_repo.props.id == repo.props.id %}
        {% if a_repo.props.has_subdir %} 
            current_repo.push({
                'data': '{{ a_repo.props.name }}',
                'attr': {'repo_id': '{{ a_repo.props.id }}'},
                'state': 'closed'
            });  
        {% else %}
            current_repo.push({
                'data': '{{ a_repo.props.name }}',
                'attr': {'repo_id': '{{ a_repo.props.id }}'}
            });
        {% endif %}
    {% else %}
        {% if a_repo.props.has_subdir %} 
            other_repos.push({
                'data': '{{ a_repo.props.name }}',
                'attr': {'repo_id': '{{ a_repo.props.id }}'},
                'state': 'closed'
            });  
        {% else %}
            other_repos.push({
                'data': '{{ a_repo.props.name }}',
                'attr': {'repo_id': '{{ a_repo.props.id }}'}
            });
        {% endif %}
    {% endif %}
    {% endfor %}
{% endif %}

function opOnDirent(context) { // added param 'context' for 'more' dirents requested with 'list_dir_more'
    var context = context || $('.dir-item, .file-item');

// select
$('.checkbox-orig', context).unbind().click(function() {
    var dirents_op = $('#dirents-op');

    $(this).parent().toggleClass('checkbox-checked');
    // show buttons or not
    if ($('.checkbox-checked', context).length > 0) {
        dirents_op.removeClass('hide');
        setDirentsOpPos();
    } else {
        dirents_op.addClass('hide');
    }
});

$('.dir-link', context).click(dirlinkClick);

{#% if repo.encrypted %#}
$('.file-download').click(function() {
    var file_name = $(this).parents('tr').data('name'),
        file_id = $(this).attr('data-fileid'); // data() will convert values, for example, '000000000...' is converted to 0

    // if file size is 0, directly download it
    if (file_id == '0000000000000000000000000000000000000000') {
        return ;
    }

    feedback("{% trans "Downloading..." %}", 'info');

    $.ajax({
        url: '{{SITE_ROOT}}ajax/repo/{{repo.id}}/encrypted_file/' + file_id + '/download/',
        dataType: 'json',
        success: function(data) {
            var block_id_list = data['blklist'],
                block_get_url_root = data['url']; 

            var blocks = [], decrypted_blocks = [];
            var workers = [], workersCount = 4, i;

            for (i = 0; i < workersCount; i++) {
                workers.push(new Worker('{{MEDIA_URL}}js/file_decrypt.js'));
            }
            for (i = 0; i < workers.length; i++){
                workers[i].addEventListener('message', onWorkerMessage, false);
            } 

            for (var i = 0, len = block_id_list.length; i < len; i++) {
                reqBlock(i);
            }

            function reqBlock(index) {
                $.ajax({
                    url: block_get_url_root + block_id_list[index],
                    beforeSend:function(xhr) {
                        xhr.overrideMimeType("text/plain; charset=x-user-defined");
                    },
                    success: function(data, textStatus, xhr) {
                        blocks.push({index: index, block: data});
                        if (blocks.length == block_id_list.length) {
                            // after receiving all blocks
                            decrypt(blocks);
                        }
                    },
                    error: function() {
                        console.log('failed to get block ' + index);
                    }
                });
            }

            function decrypt(blocks) {
                for (i = 0; i < blocks.length; i++) {
                    workers[i % workers.length].postMessage({
                        index: blocks[i].index,
                        block: blocks[i].block
                    });
                }
            }
            function onWorkerMessage(e) {
                if (typeof e.data != 'object') {
                    // error
                    return;
                }
                decrypted_blocks.push({index: e.data.index, block: e.data.fileData}); 
                console.log('cryptojs: ' + e.data.key_gen_time);
                console.log('sjcl: ' + e.data.key_gen_time2);
                if (decrypted_blocks.length == block_id_list.length ) {
                    onFinish();
                }
            }

            function onFinish() {
                var ordered_decrypted_blocks = [];
                for (var i = 0, len = decrypted_blocks.length; i < len; i++) {
                    ordered_decrypted_blocks[decrypted_blocks[i].index] = decrypted_blocks[i].block;
                }

                var str2ab = function(str) {
                    var buf = new ArrayBuffer(str.length); // 2 bytes for each char
                    var bufView = new Uint8Array(buf);
                    for (var i=0, strLen=str.length; i<strLen; i++) {
                        bufView[i] = str.charCodeAt(i);
                    }   
                    return buf;
                }; 
                var fileAsBlob = new Blob([str2ab(ordered_decrypted_blocks.join(''))], {type:''});
                var downloadLink = document.createElement("a");
                downloadLink.download = file_name;
                downloadLink.innerHTML = "Download File";
                if (window.webkitURL != null) {
                    // Chrome allows the link to be clicked without actually adding it to the DOM.
                    downloadLink.href = window.webkitURL.createObjectURL(fileAsBlob);
                    downloadLink.click();
                }
            } //onFinish ends
        }
    });
    return false;
});
{#% endif %#}

var popup_tr = ''; // the tr which the shown popup belongs to
$('#main-panel').removeClass('ovhd');
// to fix 'height becomes 0 after sort' for some versions of chrome/ff.
$('.hidden-op', context).each(function() {
    $(this).height($(this).height());
});
$('.more-op-icon', context).click(function() {
    var icon = $(this),
        hidden_op = icon.next();
    if (icon.attr('data')) { // no popup
        if (icon.position().left + icon.width() + hidden_op.outerWidth() < icon.parent().width()) {
            hidden_op.css({'left': icon.position().left + icon.width() + 5});
            if (icon.offset().top + hidden_op.height() <= $('#main').offset().top + $('#main').height()) {
                hidden_op.css('top', 6);
            } else {
                hidden_op.css('bottom', 2);
            }
        } else {
            hidden_op.css({'right':0});
            if (icon.offset().top + hidden_op.height() <= $('#main').offset().top + $('#main').height()) {
                hidden_op.css('top', icon.position().top + icon.height() + 3);
            } else {
                hidden_op.css('bottom', icon.position().top + icon.height() + 3);
            }
        }
        hidden_op.removeClass('hide');
        icon.attr('data','');
        no_file_op_popup = false;
        $('.dirent-op').data('popup_tr', icon.parents('tr'));
    } else {
        hidden_op.addClass('hide');
        icon.attr('data','no-popup');
        no_file_op_popup = true;
        $('.dirent-op').data('popup_tr', '');
    }
});
$(document).click(function(e) {
    var target =  e.target || event.srcElement;
    var popup_tr = $('.dirent-op').data('popup_tr');

    if (!no_file_op_popup &&
        !$('.more-op-icon, .hidden-op').is(target) &&
        !$('.hidden-op').find('*').is(target)) {
        $('.hidden-op').addClass('hide');
        $('.more-op-icon').attr('data', 'no-popup');
        no_file_op_popup = true;
        if (!popup_tr.find('*').is(target)) {
            popup_tr.removeClass('hl').find('.repo-file-op').addClass('vh'); // clicked place: the first tr, place out of the table
            $('.dirent-op').data('popup_tr', '');
            $('tr:gt(0)').each(function() { // when other tr is clicked
                if ($(this).find('*').is(target)) {
                    $(this).addClass('hl').find('.repo-file-op').removeClass('vh');
                }
            });
        }
    }
});

$('.hidden-op li', context).hover(
    function() {
        $(this).css('background', '#eee');
    },
    function() {
        $(this).css('background', '#fff');
    }
);
$('.dir-del, .file-del', context).click(function() {
    var dirent = $(this).parents('tr'),
        dirent_name = dirent.data('name'),
        url_main;
    if ($(this).hasClass('dir-del')) {
        url_main = '{% url 'delete_dir' repo.id %}';
    } else {
        url_main = '{% url 'delete_file' repo.id %}';
    }

    $.ajax({
        url: url_main + '?parent_dir=' + e(cur_path) + '&name=' + e(dirent_name),
        dataType: 'json',
        success: function(data) {
            if (data['success']) {
                dirent.remove();
                no_file_op_popup = true;// make other items can work normally when hover
                var msg = "{% trans "Successfully deleted %(name)s" %}";
                msg = msg.replace('%(name)s', dirent_name);
                feedback(msg, 'success'); 
                updateCmt();
            }
        },
        error: ajaxErrorHandler
    });
    return false;
});

$('.file-rename, .dir-rename', context).click(function () {
    var op = $(this),
        dirent = op.parents('tr'),
        form = $('#rename-form'),
        orig_name = dirent.data('name'),
        op_detail = $('.detail', form);
    form.data('op_obj', dirent).modal();

    op_detail.html(op_detail.html().replace('%(name)s', '<span class="op-target">' + orig_name + '</span>'));
    $('input[name*="name"]', form).val(orig_name);
    if (op.hasClass('file-rename')) {
        form.prepend("<h3>{% trans "Rename File" %}</h3>").data('obj_type', 'file');
    } else {
        form.prepend("<h3>{% trans "Rename Directory" %}</h3>").data('obj_type', 'dir');
    }

    $('#simplemodal-container').css({'width':'auto', 'height':'auto'});
    $(window).resize();// make the popup in the center of the window
    return false;
});

$('.file-cp, .file-mv, .dir-cp, .dir-mv', context).click(function () {
    var op = $(this), op_type, op_detail,
        dirent = op.parents('tr'),
        obj_name = dirent.data('name'), obj_type,
        form = $('#mv-form'), form_hd;

    form.modal({appendTo:'#main', autoResize:true, focus:false});
    $('#simplemodal-container').css({'width':'auto', 'height':'auto'});

    if (op.hasClass('file-cp')) {
        form_hd = "{% trans "Copy File" %}";
    } else if (op.hasClass('file-mv')) {
        form_hd = "{% trans "Move File" %}";
    } else if (op.hasClass('dir-cp')) {
        form_hd = "{% trans "Copy Directory" %}";
    } else if (op.hasClass('dir-mv')) {
        form_hd = "{% trans "Move Directory" %}";
    }
    
    if ($(this).hasClass('file-cp') || $(this).hasClass('dir-cp')) {
        op_type = 'cp';
        op_detail = "{% trans "Copy %(name)s to:" %}";
    } else {
        op_type = 'mv';
        op_detail = "{% trans "Move %(name)s to:" %}";
    }

    if ($(this).hasClass('file-cp') || $(this).hasClass('file-mv')) {
        obj_type = 'file';
    } else {
        obj_type = 'dir';
    }

    op_detail = op_detail.replace('%(name)s', '<span class="op-target">' + obj_name + '</span>');
    form.prepend('<h3>' + form_hd + '</h3><h4>' + op_detail + '</h4>');

    $('input[name="op"]', form).val(op_type);
    $('input[name="obj_type"]', form).val(obj_type);
    $('input[name="obj_name"]', form).val(obj_name);
    
    form.data('op_obj', dirent);

    var file_tree = new FileTree();
    file_tree.renderDirTree($('#current-repo-dirs').data('site_root', '{{SITE_ROOT}}'), form, current_repo);
    return false;
});

$('.file-update', context).click(function() {
    var file_name = $(this).parents('.file-item').data('name');
    var form = $('#update-file-form');
    var upload_success = false;
    $('#update-file-dialog').modal({
        focus:false,
        containerCss: {width:600, height:$(window).height()/2},
        onClose: function() {
            $.modal.close();
            if (upload_success) {
                reqDirData('{% url 'repo_dir_data' repo.id %}?p=' + e(cur_path));
                updateCmt();        
            }
        }
    });
    $('.simplemodal-wrap').css({'overflow':'auto'}); // for ie

    $('input[name="target_file"]', form).val(cur_path + file_name);
    var hd = $('#update-file-dialog .hd');
    hd.html(hd.html().replace('%(file_name)s', '<span class="op-target">' + file_name + '</span>'));

    // Initialize the jQuery File Upload widget:
    form.fileupload({
        url: '{{ ajax_update_url }}?head=' + $('#repo-latest-commit .commit-msg').data('cmtid'),
        maxFileSize: {{max_upload_file_size}}, // in bytes
        maxNumberOfFiles: 1 // only 1 file can be uploaded
    })
    .bind('fileuploaddone', function(e, data) {
        if (data.textStatus == 'success') {
            upload_success = true; 
        }
    });

    // Enable iframe cross-domain access via redirect option:
    form.fileupload(
        'option',
        'redirect',
        window.location.href.replace(/\/repo\/[-a-z0-9]{36}\/.*/, '/media/cors/result.html?%s')
    );

    return false;
});

$('.file-star', context).click(function() {
    var op = $(this),
        status = op.data('status'),
        file_name = op.parents('.file-item').data('name'),
        post_url;

    if (status == 'unstarred') {
        post_url = '{% url 'repo_star_file' repo.id %}?file=' + e(cur_path + file_name);
    } else {
        post_url = '{% url 'repo_unstar_file' repo.id %}?file=' + e(cur_path + file_name);
    }
    
    $.ajax({
        url: post_url,
        cache: false,
        dataType: 'json',
        success:function(data) {
            if (data['success']) {
                if (status == 'starred') {
                    op.attr('class', 'file-star icon-star-empty').attr('title', "{% trans 'unstarred' %}").data('status','unstarred');
                } else {
                    op.attr('class', 'file-star icon-star').attr('title', "{% trans 'starred' %}").data('status','starred');
                }
            }
        },
        error:function(xhr, textStatus, errorThrown) {
            if (xhr.responseText) {
                feedback(jQuery.parseJSON(xhr.responseText).error, 'error');
            } else {
                feedback("{% trans "Failed. Please check the network." %}", 'error');
            }
        }
   });
});

//share
$('.file-share, .dir-share', context).click(function() {
    var op = $(this), name, aj_url, type;
    name = op.parents('tr').data('name');
    aj_url = '{% url 'get_shared_link' %}?repo_id={{ repo.id }}&p=' + e(cur_path) + e(name);
    if (op.hasClass('dir-share')) {
        aj_url += '&type=d';
        type = 'd';
    } else {
        type = 'f';
    }

    showSharePopup(op, name, aj_url, type, cur_path);
    return false;
});

{% if ENABLE_SUB_LIBRARY and not repo.is_virtual %}
$('.dir-sync', context).click(function() {
    var dir_name = $(this).parents('.dir-item').data('name');
     
    // check if the sub-library exists
    $.ajax({
        url: '{% url 'check_sub_repo' repo.id %}?p=' + e(cur_path + dir_name),
        dataType: 'json',
        success: function(data) {
            var popup = $('#dir-sync-popup'),
                hd = $('.hd', popup);
            popup.modal({appendTo:'#main', minWidth:250, maxWidth:400});
            $('#simplemodal-container').css({'height':'auto'});

            hd.html(hd.html().replace('%(dir_name)s', '<span class="op-target">' + dir_name + '</span>'));

            if (data['exist']) {
                // sub-lib already exists
                $('.sub-repo-exist-tip', popup).removeClass('hide');
                $('#sync-sub-repo').data('sub_repo_id', data['sub_repo_id']).removeClass('hide');
            } else {
                // sub-lib doesn't exist
                $('.sub-repo-create-tip, .create-sub-repo', popup).removeClass('hide');
                $('.create-sub-repo', popup).click(createSubRepo).data('dir_name', dir_name).data('context', popup);
            }
            $('#sync-sub-repo').click(function() {
                window.open('{{ SITE_ROOT }}seafile_access_check/?repo_id=' + $(this).data('sub_repo_id'));
            });
        },
        error: ajaxErrorHandler
    });
    return false;
});

{% endif %}

} //function 'opOnDirent' ends here

$('#add-new-file-form, #add-new-dir-form, #rename-form, #mv-form').submit(function() {
    var form = $(this),
        form_id = form.attr('id'),
        post_url = '', post_data = {},
        path = cur_path,
        after_op_success = function() { };

    if (form_id == 'add-new-file-form' || form_id == 'add-new-dir-form') {
        var dirent_name = $.trim(form.find('input[name="name"]').val());

        if (!dirent_name) {
            apply_form_error(form_id, "{% trans "It is required." %}");
            return false;
        }
        if (form_id == 'add-new-file-form') {
            // if it has an extension, make sure it has a name
            if (dirent_name.lastIndexOf('.') != -1 && dirent_name.substr(0, dirent_name.lastIndexOf('.')).length == 0) {
                apply_form_error(form_id, "{% trans "Only an extension there, please input a name." %}");
                return false;
            }
            post_url = '{% url 'new_file' repo.id %}?parent_dir=' + e(path);
            after_op_success = function(data) {
                location.href = '{% url 'repo_view_file' repo.id %}?p=' + e(path) + e(data['name']);
            };
        } else {
            post_url = '{% url 'new_dir' repo.id %}?parent_dir=' + e(path);
            after_op_success = function(data) {
                form.append('<p style="color:red;">' + "{% trans "Creating..." %}" + '</p>');
                reqDirData('{% url 'repo_dir_data' repo.id %}?p=' + e(cur_path), function() {
                    $.modal.close();
                    var new_dirent = $('#repo-file-list tr[data-name="' + data['name'] + '"]'),
                        new_dirent_pos = new_dirent.offset().top,
                        window_height = $(window).height();
                    var new_dirent_bottom = $(document).height() - new_dirent_pos;
                    $('.dirent-name a', new_dirent).css({'color':'red'});
                    if (new_dirent_pos > $(window).scrollTop() + window_height/2) {
                        if (new_dirent_bottom < window_height/2) {
                            $(window).scrollTop($(document).height() - window_height);
                        } else {
                            $(window).scrollTop(new_dirent_pos - window_height/2);
                        }
                    }
                });
                updateCmt();
            };
        }
        post_data['dirent_name'] = dirent_name;
    } else if (form_id == 'rename-form') {
        var old_name = form.find('input[name="oldname"]').val(), 
            new_name = $.trim(form.find('input[name="newname"]').val()),
            op_obj = form.data('op_obj');
        if (!new_name) {
            apply_form_error(form_id, "{% trans "It is required." %}");
            return false;
        }
        if (new_name == old_name) {
            apply_form_error(form_id, "{% trans "You have not renamed it." %}");
            return false;
        }
        if (form.data('obj_type') == 'dir') {
            post_url = '{% url 'rename_dir' repo.id %}?parent_dir=' + e(path);
        } else {
            post_url = '{% url 'rename_file' repo.id %}?parent_dir=' + e(path);
        }
        post_data['oldname'] = old_name;
        post_data['newname'] = new_name;
        after_op_success = function(data) {
            $.modal.close();
            op_obj.data('name', new_name).data('time', new Date().getTime()/1000);
            updateCmt();

            var name_link = $('.dirent-name a', op_obj);
            name_link.html(new_name).attr('href', name_link.attr('href').substr(0, name_link.attr('href').indexOf('?')) + '?p=' + e(path+new_name));
            $('.dirent-update', op_obj).html("{% trans "Just now" %}");
            var dld_link; 
            if (op_obj.attr('class') == 'dir-item') {
                dld_link = $('.dir-download', op_obj), dld_href = dld_link.attr('href'); 
                dld_link.attr('href', dld_href.substr(0, dld_href.indexOf('?')) + '?p=' + e(path+new_name));
                $('.dir-share', op_obj).data('link', '').data('token', '');
            } else {
                $('.file-star', op_obj).attr('title', "{% trans "unstarred" %}").attr('class', 'icon-star-empty file-star').attr('data-status', 'unstarred');
                dld_link = $('.file-download', op_obj), dld_href = dld_link.attr('href'); 
                dld_link.attr('href', dld_href.substr(0, dld_href.indexOf('?')) + '?file_name=' + e(new_name) + '&op=download');
                $('.file-share', op_obj).data('link', '').data('token', '');

                var file_history = $('.file-history', op_obj), fh_href = file_history.attr('href');
                file_history.attr('href', fh_href.substr(0, fh_href.indexOf('?')) + '?p=' + e(path+new_name));
            }

            var msg = "{% trans "Successfully renamed %(old_name)s to %(new_name)s" %}";
            msg = msg.replace('%(old_name)s', old_name).replace('%(new_name)s', new_name);
            feedback(msg, 'success');
        };
    } else {// #mv-form
        var dst_repo = $('[name="dst_repo"]', form).val(),
            dst_path = $('[name="dst_path"]', form).val(),
            op = $('[name="op"]', form).val(),
            obj_name = $('[name="obj_name"]', form).val(),
            obj_type = $('[name="obj_type"]', form).val(),
            op_obj = form.data('op_obj');

        if (!op_obj) { // for mv-dirents, cp-dirents
            return false;
        }

        if (!$.trim(dst_repo) || !$.trim(dst_path)) {
            $('.error', form).removeClass('hide');
            return false;
        }
        if (dst_repo == '{{repo.id }}' && (dst_path == path || (obj_type == 'dir' && dst_path == path + obj_name + '/'))) {
            $('.error', form).html("{% trans "Invalid destination path" %}").removeClass('hide');
            return false;
        }
        if (op == 'mv') {
            if (obj_type == 'dir') { // move dir
                post_url = '{% url 'mv_dir' repo.id%}?path=' + e(path) + '&obj_name=' + e(obj_name);
            } else {                 // move file
                post_url = '{% url 'mv_file' repo.id%}?path=' + e(path) + '&obj_name=' + e(obj_name);
            }
        } else {
            if (obj_type == 'dir') { // copy dir
                post_url = '{% url 'cp_dir' repo.id%}?path=' + e(path) + '&obj_name=' + e(obj_name);
            } else {                 // copy file
                post_url = '{% url 'cp_file' repo.id%}?path=' + e(path) + '&obj_name=' + e(obj_name);
            }
        }
        post_data = {
            'dst_repo': dst_repo,
            'dst_path': dst_path
        };
        after_op_success = function(data) {
            $.modal.close();
            if (op=='mv') {
                op_obj.remove();
            }
            feedback(data['msg'], 'success');
            updateCmt();
        }
    }

    var submit_btn = form.children('input[type="submit"]');  
    disable(submit_btn);
    $.ajax({
        url: post_url,
        type: 'POST',
        dataType: 'json',
        beforeSend: prepareCSRFToken,
        data: post_data,
        success: function(data) {
            if (data['success']) {
                after_op_success(data);
            }
        },
        error: function(xhr, textStatus, errorThrown) {
            var err;
            if (xhr.responseText) {
                err = $.parseJSON(xhr.responseText).error;
            } else {
                err = "{% trans "Failed. Please check the network." %}";
            }
            apply_form_error(form_id, err);
            enable(submit_btn);
        }
    });
    return false;
});

$('#mv-dir-list h5').click(function() {
    var span = $(this).children('.tri-bg'),
        form = $('#mv-form'),
        dir_tree_container = $(this).next().data('site_root', '{{SITE_ROOT}}'),
        file_tree = new FileTree();
    if (span.hasClass('tri-right-bg')) {
        span.attr('class','tri-bg tri-down-bg');
        if (dir_tree_container.attr('id') == 'current-repo-dirs') {
            file_tree.renderDirTree(dir_tree_container, form, current_repo);
        } else {
            file_tree.renderDirTree(dir_tree_container, form, other_repos);
        }
        dir_tree_container.removeClass('hide');
    } else {
        span.attr('class','tri-bg tri-right-bg');
        dir_tree_container.addClass('hide');
    }
});
$('#private-share-form').submit(function() {
    if (!$('[name="emails"]', $(this)).val()) {
        apply_form_error($(this).attr('id'), "{% trans "Contacts is required." %}");
        return false;
    }
});
var last_start = 0; // for 'list_dir_more'
$(window).scroll(function() {
    var repo_top = $('#repo-top'),
        file_topbar = $('.repo-file-list-topbar'),
        list_hd = $('.repo-file-list tr:first-child'),
        repo_top_left = $('.block-inner', repo_top).offset().left,
        file_topbar_h = file_topbar.outerHeight(true);

    if ($(window).scrollTop() > repo_top.offset().top + repo_top.outerHeight(true)) {
        file_topbar.addClass('fixed-hd').css({'left': repo_top_left});  
        list_hd.addClass('fixed-hd').css({'left': repo_top_left, 'top':file_topbar_h});  
    } else {
        file_topbar.removeClass('fixed-hd');  
        list_hd.removeClass('fixed-hd');  
    }

    var ele_more = $('#repo-file-list .dirent-more');
    if (ele_more.length == 1 && $(window).scrollTop() + $(window).height() >= $(document).height() - parseInt($('#repo-file-list').css('margin-bottom')) && ele_more.data('start') != last_start) {
        last_start = ele_more.data('start');
        $.ajax({
            url:'{% url 'list_dir_more' repo.id %}?p=' + e(cur_path) + '&start=' + e(ele_more.data('start')),
            dataType: 'json',
            cache: false,
            success: function(data) {
                var more_dirents = $(data['html']);
                more_dirents.appendTo($('.repo-file-list'));
                more_dirents.unbind().hover( // remove previously binded hover handler at first
                    function() {
                        if (no_file_op_popup) {
                            $(this).addClass('hl').find('.repo-file-op').removeClass('vh');
                        }
                    },
                    function() {
                        if (no_file_op_popup) {
                            $(this).removeClass('hl').find('.repo-file-op').addClass('vh');
                        }
                    }
                );
                opOnDirent(more_dirents);
                if (data['dirent_more']) {
                    ele_more.data('start', data['more_start']); 
                } else {
                    ele_more.remove();
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                var error;
                if (xhr.responseText) {
                    error = $.parseJSON(xhr.responseText).error; 
                } else {
                    error = "{% trans "Failed. Please check the network." %}";
                }
                ele_more.replaceWith('<p class="error">' + error + '</p>');
            }
        });
    }
});
 // webkit fires 'onpopstate' when page loads, use 'setTimeout' in 'window.onload' to avoid it.
window.onload = function() {
    setTimeout(function () {
        if (window.history.pushState) {
            window.onpopstate = function(event) {
                $('#cur-dir-name').after(' ' + loading_icon);
                reqDirData('{% url 'repo_dir_data' repo.id %}' + location.search);
            }
        }
    }, 0);
}
function updateCmt() {
    $.ajax({
        url: '{% url 'get_current_commit' repo.id %}',
        cache: false,
        dataType: 'json',
        success: function(data) {
            $('#repo-latest-commit').html(data['html']);
            $('.lsch').click(function() {
                listCommitDetails($(this).data('url'), $(this).data('time'));
                return false;
            });
        },
        error: ajaxErrorHandler 
    });
}

{% if ENABLE_SUB_LIBRARY and not repo.is_virtual %}
function createSubRepo() {
    var repo_name = $(this).data('dir_name'),
        path = $(this).data('path'), // for '.create-sub-repo' in share panel
        context = $(this).data('context'),
        progress = $('.sub-repo-creating-progress', context);

    $('.sub-repo-create-tip, .create-sub-repo', context).addClass('hide');
    progress.html('{% trans "Creating sub-library..." %}').removeClass('hide').css({'color':'red'});

    $.ajax({
        url: '{% url 'create_sub_repo' repo.id %}',
        type: 'POST',
        cache: false,
        beforeSend: prepareCSRFToken,
        dataType: 'json',
        data: {
            orig_path: path || (cur_path + repo_name),
            repo_name: repo_name,
            repo_desc: repo_name
        },
        success: function(data) {
            progress.html('{% trans "Sub-library is created." %}');
            $('#sync-sub-repo, #share-sub-repo', context).removeClass('hide').data('sub_repo_id', data['sub_repo_id']);
        },
        error: ajaxErrorHandler 
   });
}

// sub-repo-share submit
   $('#share-submit-btn').click(function() {
        var cur_tab_id = $('#repo-share-tabs-nav .ui-tabs-selected a').attr('href');
        var post_data = ''; 
        switch(cur_tab_id) {
            case '#share-grp-options':
            case '#share-contact-options':
                $(cur_tab_id + ' .checkbox-checked .checkbox-orig').each(function() {
                    post_data += $(this).val() + ',';
                }); 
        }   
        if (!post_data) {
            apply_form_error('repo-share-form', '{% trans "Please select at least 1 group or 1 contact." %}');
            return false;
        }

        var form = $("#repo-share-form");
        //'email_or_group' is required. It was in 'share-enter' tab, but 'share-enter' was removed for sub-lib share.
        form.append('<input type="hidden" name="email_or_group" />');
        $('[name="email_or_group"]', form).val(post_data);
        form.submit();
        disable($(this));
    });
{% endif %}

{% include "snippets/list_commit_detail.html" %}
{% include "snippets/shared_link_js.html" %}
{% include "snippets/bottom_bar.html" %}
</script>
{% endblock %}
